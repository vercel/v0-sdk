name: Release

on:
  push:
    branches:
      - main
    paths:
      - '.changeset/**'
      - '.github/workflows/release.yml'
  workflow_dispatch:

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Temporarily hide examples from workspace
        run: |
          # Move examples out of the way so changeset doesn't see them
          mv examples examples-temp

      - name: Create Release Pull Request or Publish to npm
        id: changesets
        uses: changesets/action@v1
        with:
          version: pnpm ci:version
          publish: pnpm ci:release
          title: 'chore: version packages'
          commit: 'chore: version packages'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN_ELEVATED }}

      - name: Restore examples directory
        if: always()
        run: |
          # Restore examples directory if it was moved
          if [ -d examples-temp ]; then
            mv examples-temp examples
          fi

      - name: Update examples with new versions
        if: steps.changesets.outputs.published == 'true'
        run: |
          # Get the new version of v0-sdk
          V0_SDK_VERSION=$(node -p "require('./packages/v0-sdk/package.json').version")
          V0_REACT_VERSION=$(node -p "require('./packages/react/package.json').version")
          
          echo "Updating examples to v0-sdk@^$V0_SDK_VERSION and @v0-sdk/react@^$V0_REACT_VERSION"
          
          # Update simple-v0 example
          sed -i "s/\"v0-sdk\": \"[^\"]*\"/\"v0-sdk\": \"^$V0_SDK_VERSION\"/" examples/simple-v0/package.json
          
          # Update v0-clone example  
          sed -i "s/\"v0-sdk\": \"[^\"]*\"/\"v0-sdk\": \"^$V0_SDK_VERSION\"/" examples/v0-clone/package.json
          sed -i "s/\"@v0-sdk\/react\": \"[^\"]*\"/\"@v0-sdk\/react\": \"^$V0_REACT_VERSION\"/" examples/v0-clone/package.json
          
          # Check if there are changes to commit
          if [[ -n $(git status --porcelain) ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add examples/*/package.json
            git commit -m "chore: update examples to use published versions

          - v0-sdk@^$V0_SDK_VERSION
          - @v0-sdk/react@^$V0_REACT_VERSION"
            git push
            echo "Examples updated and committed"
          else
            echo "No changes to examples needed"
          fi
